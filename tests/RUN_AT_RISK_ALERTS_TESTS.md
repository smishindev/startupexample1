# Quick Start: Run At-Risk Student Alerts Tests

## BEFORE RUNNING TESTS - START THE APPLICATION

### Step 1: Start the application (Terminal 1 - Keep running)
```powershell
npm run dev
```

### Step 2: Set up test credentials (One-time setup)
```powershell
# Copy the example file (if not already done)
cp tests\.env.test.example tests\.env.test
```

The example file should have the correct credentials:
- `INSTRUCTOR_EMAIL=s.mishin.dev+ins1@gmail.com`
- `INSTRUCTOR_PASSWORD=Aa123456`
- `STUDENT_EMAIL=s.mishin.dev+student1@gmail.com`
- `STUDENT_PASSWORD=Aa123456`

### Step 3: Activate Python environment (Terminal 2)
```powershell
.venv\Scripts\Activate.ps1
```

### Step 4: Run the tests

#### Option A: Run all tests (headless - fastest)
```powershell
pytest tests/test_at_risk_student_alerts.py -v
```

#### Option B: Run with visible browser (see what's happening)
```powershell
$env:HEADLESS="false"
pytest tests/test_at_risk_student_alerts.py -v --headed
```

#### Option C: Run specific test
```powershell
pytest tests/test_at_risk_student_alerts.py::TestAtRiskStudentAlerts::test_risk_alerts_ui_elements_exist -v --headed
```

#### Option D: Run only UI tests (skip integration - faster)
```powershell
pytest tests/test_at_risk_student_alerts.py -v -m "not integration"
```

#### Option E: Run only integration tests (with API calls)
```powershell
pytest tests/test_at_risk_student_alerts.py -v -m "integration"
```

#### Option F: Debug mode (slow motion, stays open)
```powershell
$env:PWDEBUG="1"
pytest tests/test_at_risk_student_alerts.py::TestAtRiskStudentAlerts::test_risk_alerts_ui_elements_exist
```

## Expected Output

```
tests/test_at_risk_student_alerts.py::TestAtRiskStudentAlerts::test_risk_alerts_ui_elements_exist PASSED
tests/test_at_risk_student_alerts.py::TestAtRiskStudentAlerts::test_risk_alerts_positioned_after_security_alerts PASSED
tests/test_at_risk_student_alerts.py::TestAtRiskStudentAlerts::test_risk_alerts_inapp_toggle PASSED
tests/test_at_risk_student_alerts.py::TestAtRiskStudentAlerts::test_risk_alerts_email_toggle PASSED
tests/test_at_risk_student_alerts.py::TestAtRiskStudentAlerts::test_risk_alerts_both_toggles_independent PASSED
tests/test_at_risk_student_alerts.py::TestAtRiskStudentAlerts::test_risk_alerts_settings_persist_after_save PASSED
tests/test_at_risk_student_alerts.py::TestAtRiskStudentAlerts::test_risk_alerts_both_channels_persist PASSED
tests/test_at_risk_student_alerts.py::TestAtRiskStudentAlerts::test_risk_alerts_inherit_from_system_category PASSED
tests/test_at_risk_student_alerts.py::TestAtRiskStudentAlerts::test_risk_alerts_explicit_override_vs_inherit PASSED
tests/test_at_risk_student_alerts.py::TestAtRiskStudentAlerts::test_risk_alerts_category_off_cascades_to_subcategory PASSED
tests/test_at_risk_student_alerts.py::TestAtRiskStudentAlerts::test_risk_alerts_api_preferences_update PASSED
tests/test_at_risk_student_alerts.py::TestAtRiskStudentAlerts::test_risk_alerts_manual_trigger_endpoint PASSED
tests/test_at_risk_student_alerts.py::TestAtRiskStudentAlerts::test_risk_alerts_notification_blocked_when_disabled PASSED
tests/test_at_risk_student_alerts.py::TestAtRiskStudentAlerts::test_risk_alerts_notification_received_when_enabled PASSED
tests/test_at_risk_student_alerts.py::TestAtRiskStudentAlerts::test_risk_alerts_cannot_enable_if_global_disabled PASSED
tests/test_at_risk_student_alerts.py::TestAtRiskStudentAlerts::test_risk_alerts_only_visible_to_instructors PASSED
tests/test_at_risk_student_alerts.py::TestAtRiskStudentAlerts::test_risk_alerts_multiple_changes_before_save PASSED

======================== 17 passed in 92.45s ========================
```

## Test Coverage

### UI Rendering Tests (3 tests)
✅ UI elements exist with correct test IDs
✅ Positioned correctly after Security Alerts
✅ In-app and email switches render correctly

### Toggle Functionality Tests (3 tests)
✅ In-app toggle works
✅ Email toggle works
✅ Both toggles work independently

### Persistence Tests (2 tests)
✅ Settings persist after save and reload
✅ Both channels persist when enabled

### Inheritance Tests (3 tests)
✅ Inherit from System category when NULL
✅ Explicit override vs inherit mode
✅ Category OFF cascades to subcategory

### API Integration Tests (4 tests)
✅ Preferences update via API
✅ Manual trigger endpoint works
✅ Notifications blocked when disabled
✅ Notifications received when enabled

### Edge Cases (2 tests)
✅ Global OFF blocks all notifications
✅ Multiple changes before save
✅ Only visible to instructors (description)

## Test IDs Used

These test IDs are used in the tests (auto-generated by template):
- `notifications-settings-system-risk-alerts-inapp-switch` - In-app toggle
- `notifications-settings-system-risk-alerts-email-switch` - Email toggle
- `notifications-settings-category-system-accordion` - System alerts accordion
- `notifications-settings-category-system-accordion-summary` - System accordion header
- `notifications-settings-category-system-switch` - System category toggle
- `notifications-settings-save-button` - Save button
- `notifications-settings-enable-in-app-switch` - Global in-app toggle
- `notifications-settings-enable-email-switch` - Global email toggle

## Manual Testing via API

You can manually trigger at-risk detection and verify notifications:

```powershell
# 1. Login as instructor
$loginResponse = Invoke-RestMethod -Uri "http://localhost:3001/api/auth/login" -Method POST -Body (@{email="s.mishin.dev+ins1@gmail.com"; password="Aa123456"} | ConvertTo-Json) -ContentType "application/json"
$token = $loginResponse.data.token

# 2. Trigger at-risk detection
$headers = @{Authorization = "Bearer $token"}
Invoke-RestMethod -Uri "http://localhost:3001/api/instructor/test-at-risk-detection" -Method POST -Headers $headers -Body "{}" -ContentType "application/json"

# 3. Check notifications
Invoke-RestMethod -Uri "http://localhost:3001/api/notifications" -Method GET -Headers $headers
```

Or using curl:
```bash
# 1. Login
TOKEN=$(curl -X POST http://localhost:3001/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"s.mishin.dev+ins1@gmail.com","password":"Aa123456"}' \
  | jq -r '.data.token')

# 2. Trigger detection
curl -X POST http://localhost:3001/api/instructor/test-at-risk-detection \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json"

# 3. Get notifications
curl -X GET http://localhost:3001/api/notifications \
  -H "Authorization: Bearer $TOKEN"
```

## Troubleshooting

### 1. "Connection refused" error
→ Make sure app is running: `npm run dev`  
→ Check ports 5173 (frontend) and 3001 (backend) are available

### 2. "Login failed" error
→ Check credentials in `tests/.env.test` match QUICK_REFERENCE.md  
→ Verify instructor user exists in database

### 3. "Element not found" error
→ Run with `--headed` to see what's happening  
→ Check if test IDs match the component implementation  
→ Verify you're logged in as instructor (not student)

### 4. No at-risk students found
→ This is normal if database has no at-risk student data  
→ Tests validate settings and endpoint functionality  
→ To create test data, run: `node scripts/create-test-assessments.js`

### 5. Tests are slow
→ Run without `--headed` for faster execution  
→ Use `-m "not integration"` to skip integration tests

### 6. Screenshots on failure
→ Check `tests/screenshots/` folder  
→ Videos in `tests/videos/` folder

## Understanding the Feature

### What is At-Risk Student Detection?

**Weekly Automated Detection:**
- Runs every Monday at 10:00 AM UTC
- Identifies students who are:
  - Inactive for 7+ days, OR
  - Have "critical" risk level

**Notification Details:**
- **Type**: intervention
- **Category**: system
- **Subcategory**: RiskAlerts
- **Recipients**: Instructors only (one notification per instructor per course)
- **Priority**: urgent (if critical students exist), else high
- **Grouping**: Lists all at-risk students in the course with risk breakdown

**Settings Control:**
- Category: System Alerts
- Subcategory: At-Risk Student Alerts
- Independent in-app and email toggles
- Inherits from System Alerts category when NULL
- Can be explicitly overridden

### Database Tables Involved

**NotificationPreferences:**
- `EnableRiskAlerts BIT NULL` - In-app notifications
- `EmailRiskAlerts BIT NULL` - Email notifications

**StudentRiskAssessment:**
- Contains risk level data (medium, high, critical)
- Used for detection queries
- Filtered index on RiskLevel and CourseId

**Notifications:**
- Stores created notifications
- 7-day duplicate prevention window

## For More Details

See:
- `AT_RISK_DETECTION_IMPLEMENTATION.md` - Full implementation documentation
- `tests/NOTIFICATION_SETTINGS_TESTS.md` - Notification settings testing guide
- `TESTING_GUIDE.md` - General testing guide
- `TEST_SELECTOR_MAP_ORGANIZED.md` - Complete test ID reference
